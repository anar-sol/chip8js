(()=>{"use strict";class e extends Error{constructor(e){super(e),this.name="RAMException"}}class t{#e;constructor(e){this.#e=new Uint8Array(e)}static newRAM(e){return new t(e)}readByte(t){if(t<0||t>=this.#e.length)throw new e(`RAM address ${t} is out of bound`);return this.#e[t]}writeByte(t,s){if(t<0||t>=this.#e.length)throw new e(`RAM address ${t} is out of bound`);this.#e[t]=s}readDoubleByte(e){return this.readByte(e)<<8|this.readByte(e+1)}writeRange(t,s){if(t<0)throw new e(`RAM address ${t} is out of bound`);if(t+s.length>this.#e.length)throw new e(`RAM address ${t+s.length-1} is out of bound`);for(let e=0;e<s.length;e++)this.writeByte(t+e,s[e])}readRange(t,s){if(t<0)throw new e(`RAM address ${t} is out of bound`);if(t+s>this.#e.length)throw new e(`RAM address ${t+s-1} is out of bound`);return this.#e.subarray(t,t+s)}}class s extends Error{constructor(e){super(e),this.name="RAMException"}}class r{static V0=0;static V1=1;static V2=2;static V3=3;static V4=4;static V5=5;static V6=6;static V7=7;static V8=8;static V9=9;static VA=10;static VB=11;static VC=12;static VD=13;static VE=14;static VF=15;static DELAY=16;static SOUND=17;static SP=18;static I=19;static PC=20;static#t=19;static#s=2;#r;#i;constructor(){this.#n()}static newRegisters(){return new r}#n(){this.#r=new Uint8Array(r.#t),this.#i=new Uint16Array(r.#s)}write(e,t){e<r.#t?this.#r[e]=t:this.#i[e-r.#t]=t}read(e){return e<r.#t?this.#r[e]:this.#i[e-r.#t]}writeRange(e=r.V0,t){for(const s of t)this.write(e++,s)}readRange(e,t){return this.#r.subarray(e,e+t)}}function i(e){return new Promise((t=>setTimeout(t,e)))}function n(e,t){return(e&15<<4*t)>>>4*t}class c{#c;constructor(e){this.#c=e}execute(e){}get registerX(){return n(this.#c,2)}get registerY(){return n(this.#c,1)}get address(){return 4095&this.#c}get byte(){return 255&this.#c}get nibble(){return n(this.#c,0)}}class a extends Error{constructor(e){super(e),this.name="InstructionException"}}class h extends c{execute(e){e.screen.clear()}}class o extends c{execute(e){const t=e.stack.pop();e.registers.write(r.PC,t)}}class u extends c{constructor(e){super(e)}execute(e){e.registers.write(r.PC,this.address)}}class d extends c{constructor(e){super(e)}execute(e){const t=e.registers.read(r.PC);e.stack.push(t),e.registers.write(r.PC,this.address)}}class g extends c{constructor(e){super(e)}execute(e){if(e.registers.read(this.registerX)===this.byte){const t=e.registers.read(r.PC);e.registers.write(r.PC,t+2)}}}class l extends c{constructor(e){super(e)}execute(e){if(e.registers.read(this.registerX)!==this.byte){const t=e.registers.read(r.PC);e.registers.write(r.PC,t+2)}}}class w extends c{constructor(e){super(e)}execute(e){if(e.registers.read(this.registerX)===e.registers.read(this.registerY)){const t=e.registers.read(r.PC);e.registers.write(r.PC,t+2)}}}class p extends c{constructor(e){super(e)}execute(e){e.registers.write(this.registerX,this.byte)}}class y extends c{constructor(e){super(e)}execute(e){const t=e.registers.read(this.registerX);e.registers.write(this.registerX,t+this.byte)}}class x extends c{constructor(e){super(e)}execute(e){e.registers.write(this.registerX,e.registers.read(this.registerY))}}class f extends c{constructor(e){super(e)}execute(e){const t=e.registers.read(this.registerX),s=e.registers.read(this.registerY);e.registers.write(this.registerX,s|t)}}class R extends c{constructor(e){super(e)}execute(e){const t=e.registers.read(this.registerX),s=e.registers.read(this.registerY);e.registers.write(this.registerX,s&t)}}class k extends c{constructor(e){super(e)}execute(e){const t=e.registers.read(this.registerX),s=e.registers.read(this.registerY);e.registers.write(this.registerX,s^t)}}class b extends c{constructor(e){super(e)}execute(e){const t=e.registers.read(this.registerX),s=e.registers.read(this.registerY)+t,i=s>255?1:0;e.registers.write(this.registerX,s),e.registers.write(r.VF,i)}}class _ extends c{constructor(e){super(e)}execute(e){const t=e.registers.read(this.registerX)-e.registers.read(this.registerY),s=t<0?0:1;e.registers.write(this.registerX,t),e.registers.write(r.VF,s)}}class m extends c{constructor(e){super(e)}execute(e){const t=e.registers.read(this.registerY);e.registers.write(r.VF,1&t),e.registers.write(this.registerX,t>>>1)}}class E extends c{constructor(e){super(e)}execute(e){const t=e.registers.read(this.registerX),s=e.registers.read(this.registerY)-t,i=s<0?0:1;e.registers.write(this.registerX,s),e.registers.write(r.VF,i)}}class v extends c{constructor(e){super(e)}execute(e){const t=e.registers.read(this.registerY);e.registers.write(r.VF,(128&t)>>>7),e.registers.write(this.registerX,t<<1)}}class P extends c{constructor(e){super(e)}execute(e){e.registers.read(this.registerX)!==e.registers.read(this.registerY)&&e.registers.write(r.PC,e.registers.read(r.PC)+2)}}class S extends c{constructor(e){super(e)}execute(e){e.registers.write(r.I,this.address)}}class X extends c{constructor(e){super(e)}execute(e){e.registers.write(this.registerX,this.#a()&this.byte)}#a(){return Math.floor(256*Math.random())}}class B extends c{constructor(e){super(e)}execute(e){const t=this.nibble,s=e.registers.read(this.registerX)%e.screen.width,i=e.registers.read(this.registerY)%e.screen.height,n=e.ram.readRange(e.registers.read(r.I),t);e.registers.write(r.VF,0);for(let r=0;r<t;r++)this.#h(e,s,i+r,n[r])}#h(e,t,s,i){let n=128;for(let c=7;c>=0;c--){const a=(i&n)>>>c;n>>>=1;const h=e.screen.getPixel(t,s);e.screen.setPixel(t,s,a^h),a&&h&&e.registers.write(r.VF,1),t++}}}class I extends c{constructor(e){super(e)}execute(e){e.registers.write(r.PC,this.address+e.registers.read(r.V0))}}class A extends c{constructor(e){super(e)}execute(e){const t=e.registers.read(this.registerX);e.keyboard.isPressed(t)&&e.registers.write(r.PC,e.registers.read(r.PC)+2)}}class C extends c{constructor(e){super(e)}execute(e){const t=e.registers.read(this.registerX);e.keyboard.isPressed(t)||e.registers.write(r.PC,e.registers.read(r.PC)+2)}}class L extends c{constructor(e){super(e)}execute(e){e.registers.write(r.DELAY,e.registers.read(this.registerX))}}class V extends c{constructor(e){super(e)}execute(e){const t=this.registerX;e.pause(),e.keyboard.onKeyPressed((s=>{e.registers.write(t,s),e.resume()}))}}class D extends c{constructor(e){super(e)}execute(e){e.registers.write(this.registerX,e.registers.read(r.DELAY))}}class T extends c{constructor(e){super(e)}execute(e){e.registers.write(r.SOUND,e.registers.read(this.registerX))}}class M extends c{constructor(e){super(e)}execute(e){e.registers.write(r.I,e.registers.read(r.I)+e.registers.read(this.registerX))}}class K extends c{constructor(e){super(e)}execute(e){const t=e.registers.read(this.registerX),s=e.getSpriteAddr(t);e.registers.write(r.I,s)}}class Y extends c{constructor(e){super(e)}execute(e){const t=e.registers.read(r.I),s=function(e){const t=new Array;do{const s=e%10;t.push(s),e=Math.floor(e/10)}while(e>0);return t.reverse(),t}(e.registers.read(this.registerX));e.ram.writeRange(t,s)}}class F extends c{constructor(e){super(e)}execute(e){const t=e.registers.read(r.I),s=e.registers.readRange(r.V0,this.registerX+1);e.ram.writeRange(t,s),e.registers.write(r.I,t+this.registerX+1)}}class N extends c{constructor(e){super(e)}execute(e){const t=e.registers.read(r.I),s=e.ram.readRange(t,this.registerX+1);e.registers.writeRange(r.V0,s),e.registers.write(r.I,t+this.registerX+1)}}class O{static decode(e){switch(O.#o(e)){case 0:switch(n(e,0)){case 0:return new h;case 14:return new o}break;case 1:return new u(e);case 2:return new d(e);case 3:return new g(e);case 4:return new l(e);case 5:return new w(e);case 6:return new p(e);case 7:return new y(e);case 8:switch(n(e,0)){case 0:return new x(e);case 1:return new f(e);case 2:return new R(e);case 3:return new k(e);case 4:return new b(e);case 5:return new _(e);case 6:return new m(e);case 7:return new E(e);case 14:return new v(e)}case 9:return new P(e);case 10:return new S(e);case 11:return new I(e);case 12:return new X(e);case 13:return new B(e);case 14:switch(this.#u(e)){case 158:return new A(e);case 161:return new C(e)}case 15:switch(this.#u(e)){case 7:return new D(e);case 10:return new V(e);case 21:return new L(e);case 24:return new T(e);case 30:return new M(e);case 41:return new K(e);case 51:return new Y(e);case 85:return new F(e);case 101:return new N(e)}}}static#o(e){return n(e,3)}static#u(e){return 255&e}}const U=[[240,144,144,144,240],[32,96,32,32,112],[240,16,240,128,240],[240,16,240,16,240],[144,144,240,16,16],[240,128,240,16,240],[240,128,240,144,240],[240,16,32,64,64],[240,144,240,144,240],[240,144,240,16,240],[240,144,240,144,144],[224,144,224,144,224],[240,128,128,128,240],[224,144,144,144,224],[240,128,240,128,240],[240,128,240,128,128]];class q{#d;#g;constructor(){this.#d=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.#g=null}pressKey(e){this.#d[e]=!0,null!==this.#g&&this.#g(e)}releaseKey(e){this.#d[e]=!1}isPressed(e){return this.#d[e]}onKeyPressed(e){this.#g=e}}class W{#l;#w;#p;#y;#x;#f;#R;constructor(){this.#k()}static newChip8(){return new W}get pc(){return this.#w.read(r.PC)}set pc(e){this.#w.write(r.PC,e)}get i(){return this.#w.read(r.I)}set i(e){this.#w.write(r.I,e)}get dt(){return this.#w.read(r.DELAY)}set dt(e){this.#w.write(r.DELAY,e)}get st(){return this.#w.read(r.SOUND)}set st(e){this.#w.write(r.SOUND,e)}get sp(){return this.#w.read(r.SP)}get stack(){return this.#p}get progStartAddr(){return 512}get ram(){return this.#l}get registers(){return this.#w}get screen(){return this.#y}set screen(e){this.#y=e}get keyboard(){return this.#x}get isRunning(){return this.#f}loadROM(e){this.#l.writeRange(512,e)}pause(){this.#f=!1}resume(){this.#f=!0}exit(){this.#R=!0,this.#k()}readRegister(e){return this.#w.read(e)}writeRegister(e,t){this.#w.write(e,t)}readRAMRange(e,t){return this.#l.readRange(e,t)}pushToStack(e){this.#p.push(e)}getSpriteAddr(e){return e*U[0].length}execute(){O.decode(this.#b()).execute(this)}async run(e){this.#R=!1,this.#f=!0;const t=Math.floor(.017*e);let s=Date.now();for(;!this.#R;){this.#f&&this.#_(t);let e=Date.now()-s;await i(17-e),s=Date.now()}}#k(){this.#l=t.newRAM(4096),this.#w=r.newRegisters(),this.#p=new Array,this.#w.write(r.PC,512),this.#w.write(r.SP,0),this.#x=new q,this.#f=!1,this.#m(),null!=this.#y&&this.#y.clear()}#_(e){this.dt>0&&this.dt--,this.st>0&&this.st--;for(let t=0;t<e;t++)this.execute()}#m(){let e=0;for(const t of U)this.#l.writeRange(e,t),e+=t.length}#E(){this.pc+=2}#b(){const e=this.#l.readDoubleByte(this.pc);return this.#E(),e}}class G{constructor(e,t,s){this.canvas=e,this.canvasWidth=e.width,this.canvasHeight=e.height,this.context=e.getContext("2d"),this.width=t,this.height=s,this.pixelWidth=this.canvasWidth/this.width,this.pixelHeight=this.canvasHeight/this.height,this.buffer=function(e,t){const s=new Array;for(let t=0;t<e;t++)s.push(new Array);for(let r=0;r<e;r++)for(let e=0;e<t;e++)s[r].push(!1);return s}(t,s)}static create(e,t=64,s=32){return new G(e,t,s)}getPixel(e,t){return e<this.width&&t<this.height&&this.buffer[e][t]}setPixel(e,t,s){e<this.width&&t<this.height&&(this.buffer[e][t]=s)}clear(){for(let e=0;e<this.width;e++)for(let t=0;t<this.height;t++)this.buffer[e][t]=!1}render(){this.context.clearRect(0,0,this.canvasWidth,this.canvasHeight);for(let e=0;e<this.width;e++)for(let t=0;t<this.height;t++)this.buffer[e][t]&&this.context.fillRect(e*this.pixelWidth,t*this.pixelHeight,this.pixelWidth,this.pixelHeight)}}const H=new Map([["Digit1",1],["Digit2",2],["Digit3",3],["Digit4",12],["KeyQ",4],["KeyW",5],["KeyE",6],["KeyR",13],["KeyA",7],["KeyS",8],["KeyD",9],["KeyF",14],["KeyZ",10],["KeyX",0],["KeyC",11],["KeyV",15]]),$=new Map([["key0",0],["key1",1],["key2",2],["key3",3],["key4",4],["key5",5],["key6",6],["key7",7],["key8",8],["key9",9],["keyA",10],["keyB",11],["keyC",12],["keyD",13],["keyE",14],["keyF",15]]);class z{constructor(e){this.chip8=e}static create(e){return new z(e)}handle(e){switch(e.type){case"keydown":H.has(e.code)&&this.chip8.keyboard.pressKey(H.get(e.code));break;case"keyup":H.has(e.code)&&this.chip8.keyboard.releaseKey(H.get(e.code));break;case"mousedown":case"pointerdown":{e.preventDefault();const t=e.currentTarget.id;$.has(t)&&this.chip8.keyboard.pressKey($.get(t));break}case"mouseup":case"pointerup":{e.preventDefault();const t=e.currentTarget.id;$.has(t)&&this.chip8.keyboard.releaseKey($.get(t));break}}}}(()=>{const e=new Map([["Breakout","Breakout (Brix hack) [David Winter, 1997].ch8"],["IBM Logo","IBM Logo.ch8"],["Pong","Pong (1 player).ch8"],["Tetris","Tetris [Fran Dachille, 1991].ch8"]]);let t=null;const s=document.querySelector(".chip8__help--controls"),r=document.querySelector(".chip8__help--loading"),i=document.querySelector(".chip8__help--error");s.classList.add("chip8__help--active");const n=document.querySelector(".chip8__screen");n.width=n.clientWidth,n.height=n.clientHeight,n.getContext("2d").fillStyle="#ffffff";const c=document.querySelector(".chip8__select--rom"),a=document.querySelector(".chip8__button--start"),h=document.querySelector(".chip8__button--stop"),o=document.querySelectorAll(".chip8__key");!function(){for(const[t,s]of e){const e=new Option(t,s);c.add(e)}}();const u=W.newChip8(),d=G.create(n);u.screen=d;const g=z.create(u);document.addEventListener("keydown",(e=>{g.handle(e)})),document.addEventListener("keyup",(e=>{g.handle(e)}));for(const e of o)e.addEventListener("mousedown",(e=>{g.handle(e)})),e.addEventListener("pointerdown",(e=>{g.handle(e)})),e.addEventListener("mouseup",(e=>{g.handle(e)})),e.addEventListener("pointerup",(e=>{g.handle(e)}));c.addEventListener("change",(e=>{if(""!==c.value){t=null,i.classList.remove("chip8__help--active"),s.classList.remove("chip8__help--active"),r.classList.add("chip8__help--active");const e=new URL("roms/"+c.value,document.documentURI);fetch(e).then((e=>{if(!e.ok)throw r.classList.remove("chip8__help--active"),i.classList.add("chip8__help--active"),new Error("HTTP error ",e.status);return e.arrayBuffer()})).then((e=>{t=new Uint8Array(e),u.exit(),u.loadROM(t),r.classList.remove("chip8__help--active"),s.classList.add("chip8__help--active")}))}})),a.addEventListener("click",(async()=>{u.isRunning||null===t||(i.classList.remove("chip8__help--active"),s.classList.remove("chip8__help--active"),u.exit(),u.loadROM(t),u.run(700))})),h.addEventListener("click",(()=>{u.isRunning&&(s.classList.add("chip8__help--active"),u.exit())})),function e(){window.requestAnimationFrame(e),d.render()}()})()})();